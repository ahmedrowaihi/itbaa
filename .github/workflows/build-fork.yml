name: Build from Fork

on:
    workflow_dispatch:

jobs:
    build:
        name: Build ${{ matrix.os_name }}-${{ matrix.arch }}
        runs-on: ${{ matrix.runner }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    - os_name: linux
                      arch: x86_64
                      runner: ubuntu-24.04
                      toolchain: GNU

                    - os_name: linux
                      arch: arm64
                      runner: ubuntu-24.04-arm
                      toolchain: Clang

                    - os_name: macos
                      arch: arm64
                      runner: macos-14
                      toolchain: Clang

        steps:
            - name: Checkout Itbaa
              uses: actions/checkout@v4

            - name: Checkout Ladybird from fork (upstream branch)
              uses: actions/checkout@v4
              with:
                  repository: ahmedrowaihi/ladybird-itbaa
                  ref: upstream
                  path: ladybird
                  fetch-depth: 1

            - name: Apply Itbaa patches
              run: |
                  cd ladybird
                  git apply ../patches/*.patch

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Python dependencies
              run: pip install pyyaml requests six

            - name: Install Dependencies (Linux)
              if: matrix.os_name == 'linux'
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y autoconf autoconf-archive automake build-essential \
                    ccache cmake curl fonts-liberation2 gcc-14 g++-14 git libcurl4-openssl-dev \
                    libdrm-dev libgl1-mesa-dev libssl-dev libstdc++-14-dev libtool nasm \
                    ninja-build pkg-config python3-venv tar unzip zip

                  if [ "${{ matrix.toolchain }}" == "Clang" ]; then
                    curl -f -o /tmp/llvm.key https://apt.llvm.org/llvm-snapshot.gpg.key
                    sudo install -D /tmp/llvm.key /usr/share/keyrings/llvm-snapshot.gpg.key
                    echo "deb [signed-by=/usr/share/keyrings/llvm-snapshot.gpg.key] https://apt.llvm.org/noble/ llvm-toolchain-noble-20 main" | sudo tee /etc/apt/sources.list.d/llvm.list
                    sudo apt-get update -y
                    sudo apt-get install -y clang-20 lld-20
                  fi

                  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
                  sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100

            - name: Install Dependencies (macOS)
              if: matrix.os_name == 'macos'
              run: |
                  brew update
                  brew install autoconf autoconf-archive automake bash ccache cmake coreutils \
                    libtool llvm@20 nasm ninja pkg-config unzip

            - name: Setup ccache
              uses: hendrikmuhs/ccache-action@v1
              with:
                  key: ${{ matrix.os_name }}-${{ matrix.arch }}-fork-upstream
                  max-size: 3G

            - name: Create cache directories
              run: mkdir -p ladybird/Build/caches/vcpkg-binary-cache

            - name: Restore vcpkg binary cache
              uses: actions/cache/restore@v4
              id: vcpkg-cache
              with:
                  path: ladybird/Build/caches/vcpkg-binary-cache
                  key: vcpkg-binary-${{ matrix.os_name }}-${{ matrix.arch }}-fork-upstream
                  restore-keys: vcpkg-binary-${{ matrix.os_name }}-${{ matrix.arch }}-

            - name: Setup vcpkg
              working-directory: ladybird
              run: ./Toolchain/BuildVcpkg.py

            - name: Save vcpkg binary cache
              uses: actions/cache/save@v4
              if: always() && steps.vcpkg-cache.outputs.cache-hit != 'true'
              continue-on-error: true
              with:
                  path: ladybird/Build/caches/vcpkg-binary-cache
                  key: vcpkg-binary-${{ matrix.os_name }}-${{ matrix.arch }}-fork-upstream

            - name: Set compiler (Linux GNU)
              if: matrix.os_name == 'linux' && matrix.toolchain == 'GNU'
              run: |
                  echo "CC=gcc-14" >> "$GITHUB_ENV"
                  echo "CXX=g++-14" >> "$GITHUB_ENV"

            - name: Set compiler (Linux Clang)
              if: matrix.os_name == 'linux' && matrix.toolchain == 'Clang'
              run: |
                  echo "CC=clang-20" >> "$GITHUB_ENV"
                  echo "CXX=clang++-20" >> "$GITHUB_ENV"

            - name: Set compiler (macOS)
              if: matrix.os_name == 'macos'
              run: |
                  echo "CC=$(brew --prefix llvm@20)/bin/clang" >> "$GITHUB_ENV"
                  echo "CXX=$(brew --prefix llvm@20)/bin/clang++" >> "$GITHUB_ENV"

            - name: Configure
              working-directory: ladybird
              run: |
                  if [ "${{ matrix.os_name }}" == "macos" ]; then
                    cmake --preset Itbaa_Static -B Build \
                      -DCMAKE_C_COMPILER="$CC" \
                      -DCMAKE_CXX_COMPILER="$CXX" \
                      -DBUILD_TESTING=OFF \
                      -DENABLE_CI_BASELINE_CPU=ON \
                      -DPython3_EXECUTABLE="${{ env.pythonLocation }}/bin/python" \
                      -DCMAKE_OSX_DEPLOYMENT_TARGET="11.0"
                  else
                    cmake --preset Itbaa_Static -B Build \
                      -DCMAKE_C_COMPILER="$CC" \
                      -DCMAKE_CXX_COMPILER="$CXX" \
                      -DBUILD_TESTING=OFF \
                      -DENABLE_CI_BASELINE_CPU=ON \
                      -DPython3_EXECUTABLE="${{ env.pythonLocation }}/bin/python"
                  fi

            - name: Build
              working-directory: ladybird
              run: cmake --build Build --target itbaa-cli

            - name: Prepare artifact
              run: |
                  mkdir -p artifact
                  # Binary is named 'itbaa' not 'itbaa-cli'
                  cp ladybird/Build/bin/itbaa artifact/itbaa-${{ matrix.os_name }}-${{ matrix.arch }}
                  chmod +x artifact/itbaa-${{ matrix.os_name }}-${{ matrix.arch }}

                  # Create archive
                  cd artifact
                  if [ "${{ matrix.os_name }}" == "linux" ]; then
                    tar -czvf itbaa-${{ matrix.os_name }}-${{ matrix.arch }}.tar.gz itbaa-${{ matrix.os_name }}-${{ matrix.arch }}
                  else
                    zip itbaa-${{ matrix.os_name }}-${{ matrix.arch }}.zip itbaa-${{ matrix.os_name }}-${{ matrix.arch }}
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: itbaa-${{ matrix.os_name }}-${{ matrix.arch }}
                  path: artifact/itbaa-${{ matrix.os_name }}-${{ matrix.arch }}.*
